{"version":3,"sources":["../../../../../../packages/react-virtualizer/src/components/VirtualizerScrollViewDynamic/useVirtualizerScrollViewDynamic.tsx"],"sourcesContent":["import * as React from 'react';\nimport { slot, useMergedRefs } from '@fluentui/react-utilities';\nimport { useVirtualizer_unstable } from '../Virtualizer/useVirtualizer';\nimport type {\n  VirtualizerScrollViewDynamicProps,\n  VirtualizerScrollViewDynamicState,\n} from './VirtualizerScrollViewDynamic.types';\nimport { useDynamicVirtualizerMeasure } from '../../Hooks';\nimport {\n  useVirtualizerContextState_unstable,\n  scrollToItemDynamic,\n} from '../../Utilities';\nimport type { VirtualizerDataRef } from '../Virtualizer/Virtualizer.types';\nimport { useMeasureList } from '../../hooks/useMeasureList';\nimport type { IndexedResizeCallbackElement } from '../../hooks/useMeasureList';\nimport { useDynamicVirtualizerPagination } from '../../hooks/useDynamicPagination';\n\nexport function useVirtualizerScrollViewDynamic_unstable(\n  props: VirtualizerScrollViewDynamicProps\n): VirtualizerScrollViewDynamicState {\n  'use no memo';\n\n  const contextState = useVirtualizerContextState_unstable(\n    props.virtualizerContext\n  );\n  const {\n    imperativeRef,\n    axis = 'vertical',\n    reversed,\n    imperativeVirtualizerRef,\n    enablePagination = false,\n    bufferItems: _bufferItems,\n    bufferSize: _bufferSize,\n    enableScrollAnchor,\n    gap = 0,\n  } = props;\n\n  const sizeTrackingArray = React.useRef<number[]>(\n    new Array(props.numItems).fill(props.itemSize)\n  );\n\n  const getChildSizeAuto = (index: number) => {\n    if (\n      sizeTrackingArray.current.length <= index ||\n      sizeTrackingArray.current[index] <= 0\n    ) {\n      // Default size for initial state or untracked\n      return props.itemSize;\n    }\n    /* Required to be defined prior to our measure function\n     * we use a sizing array ref that we will update post-render\n     */\n    return sizeTrackingArray.current[index];\n  };\n\n  const {\n    virtualizerLength,\n    bufferItems,\n    bufferSize,\n    scrollRef,\n    containerSizeRef,\n    updateScrollPosition,\n  } = useDynamicVirtualizerMeasure({\n    defaultItemSize: props.itemSize,\n    direction: props.axis ?? 'vertical',\n    getItemSize: props.getItemSize ?? getChildSizeAuto,\n    virtualizerContext: contextState,\n    numItems: props.numItems,\n    bufferItems: _bufferItems,\n    bufferSize: _bufferSize,\n    gap,\n  });\n\n  const _imperativeVirtualizerRef = useMergedRefs(\n    React.useRef<VirtualizerDataRef>(null),\n    imperativeVirtualizerRef\n  );\n\n  const paginationRef = useDynamicVirtualizerPagination(\n    {\n      axis,\n      progressiveItemSizes: _imperativeVirtualizerRef.current?.progressiveSizes,\n      actualNodeSizes: sizeTrackingArray,\n      virtualizerLength,\n      currentIndex: contextState?.contextIndex ?? 0,\n    },\n    enablePagination\n  );\n\n  // Store the virtualizer length as a ref for imperative ref access\n  const virtualizerLengthRef = React.useRef<number>(virtualizerLength);\n  if (virtualizerLengthRef.current !== virtualizerLength) {\n    virtualizerLengthRef.current = virtualizerLength;\n  }\n  const localScrollRef = React.useRef<HTMLDivElement>(null);\n  const scrollViewRef = useMergedRefs(\n    props.scrollViewRef,\n    scrollRef,\n    paginationRef,\n    localScrollRef\n  );\n  const scrollCallbackRef = React.useRef<null | ((index: number) => void)>(\n    null\n  );\n\n  React.useImperativeHandle(\n    imperativeRef,\n    () => {\n      return {\n        scrollToPosition(\n          position: number,\n          behavior: ScrollBehavior = 'auto',\n          index?: number, // So we can callback when index rendered\n          callback?: (index: number) => void\n        ) {\n          if (callback) {\n            scrollCallbackRef.current = callback ?? null;\n          }\n\n          if (_imperativeVirtualizerRef.current) {\n            if (index !== undefined) {\n              _imperativeVirtualizerRef.current.setFlaggedIndex(index);\n            }\n            const positionOptions =\n              axis == 'vertical' ? { top: position } : { left: position };\n            scrollViewRef.current?.scrollTo({\n              behavior,\n              ...positionOptions,\n            });\n          }\n        },\n        scrollTo(\n          index: number,\n          behavior = 'auto',\n          callback: undefined | ((index: number) => void)\n        ) {\n          scrollCallbackRef.current = callback ?? null;\n          if (_imperativeVirtualizerRef.current) {\n            const progressiveSizes =\n              _imperativeVirtualizerRef.current.progressiveSizes.current;\n            const totalSize =\n              progressiveSizes && progressiveSizes?.length > 0\n                ? progressiveSizes[Math.max(progressiveSizes.length - 1, 0)]\n                : 0;\n\n            _imperativeVirtualizerRef.current.setFlaggedIndex(index);\n            scrollToItemDynamic({\n              index,\n              getItemSize: props.getItemSize ?? getChildSizeAuto,\n              totalSize,\n              scrollViewRef: scrollViewRef as React.RefObject<HTMLDivElement>,\n              axis,\n              reversed,\n              behavior,\n              gap,\n            });\n          }\n        },\n        currentIndex: _imperativeVirtualizerRef.current?.currentIndex,\n        virtualizerLength: virtualizerLengthRef,\n        sizeTrackingArray,\n      };\n    },\n    [axis, scrollViewRef, reversed, _imperativeVirtualizerRef]\n  );\n\n  const handleRenderedIndex = (index: number) => {\n    if (scrollCallbackRef.current) {\n      scrollCallbackRef.current(index);\n    }\n  };\n\n  const virtualizerState = useVirtualizer_unstable({\n    ...props,\n    getItemSize: props.getItemSize ?? getChildSizeAuto,\n    virtualizerLength,\n    bufferItems,\n    bufferSize,\n    virtualizerContext: contextState,\n    imperativeVirtualizerRef: _imperativeVirtualizerRef,\n    onRenderedFlaggedIndex: handleRenderedIndex,\n    containerSizeRef,\n    scrollViewRef,\n    updateScrollPosition,\n  });\n\n  const requestScrollBy = React.useCallback(\n    (sizeChange: number) => {\n      // Handle any size changes so that scroll view doesn't jump around\n      if (enableScrollAnchor) {\n        localScrollRef.current?.scrollBy({\n          top: axis === 'vertical' ? sizeChange : 0,\n          left: axis === 'vertical' ? 0 : sizeChange,\n          behavior: 'instant',\n        });\n      }\n    },\n    [enableScrollAnchor, axis, localScrollRef]\n  );\n\n  const measureObject = useMeasureList({\n    currentIndex: Math.max(virtualizerState.virtualizerStartIndex, 0),\n    totalLength: props.numItems,\n    defaultItemSize: props.itemSize,\n    sizeTrackingArray,\n    axis,\n    virtualizerLength,\n    requestScrollBy,\n  });\n\n  // Enables auto-measuring and tracking post render sizes externally\n  React.Children.map(virtualizerState.virtualizedChildren, (child, index) => {\n    if (React.isValidElement(child)) {\n      virtualizerState.virtualizedChildren[index] = (\n        <child.type\n          {...child.props}\n          key={child.key}\n          ref={(element: HTMLElement & IndexedResizeCallbackElement) => {\n            if (Object.prototype.hasOwnProperty.call(child, 'ref')) {\n              // We must access this from the child directly, not props (forward ref).\n              // eslint-disable-next-line  @typescript-eslint/no-explicit-any\n              const localRef = (child as any)?.ref;\n\n              if (typeof localRef === 'function') {\n                localRef(element);\n              } else if (localRef) {\n                localRef.current = element;\n              }\n            }\n\n            // Call the auto-measure ref attachment.\n            measureObject.createIndexedRef(index)(element);\n          }}\n        />\n      );\n    }\n  });\n\n  return {\n    ...virtualizerState,\n    enableScrollAnchor,\n    components: {\n      ...virtualizerState.components,\n      container: 'div',\n    },\n    container: slot.always(props.container, {\n      defaultProps: {\n        ref: scrollViewRef,\n      },\n      elementType: 'div',\n    }),\n  };\n}\n"],"names":["useVirtualizerScrollViewDynamic_unstable","props","_imperativeVirtualizerRef","contextState","useVirtualizerContextState_unstable","virtualizerContext","imperativeRef","axis","reversed","imperativeVirtualizerRef","enablePagination","bufferItems","_bufferItems","bufferSize","_bufferSize","enableScrollAnchor","gap","sizeTrackingArray","React","useRef","Array","numItems","fill","itemSize","getChildSizeAuto","index","current","length","virtualizerLength","scrollRef","containerSizeRef","updateScrollPosition","useDynamicVirtualizerMeasure","defaultItemSize","direction","getItemSize","useMergedRefs","paginationRef","useDynamicVirtualizerPagination","progressiveItemSizes","progressiveSizes","actualNodeSizes","currentIndex","contextIndex","virtualizerLengthRef","localScrollRef","scrollViewRef","scrollCallbackRef","useImperativeHandle","scrollToPosition","position","behavior","callback","undefined","setFlaggedIndex","positionOptions","top","left","scrollTo","totalSize","Math","max","scrollToItemDynamic","handleRenderedIndex","virtualizerState","useVirtualizer_unstable","onRenderedFlaggedIndex","requestScrollBy","useCallback","sizeChange","scrollBy","measureObject","useMeasureList","virtualizerStartIndex","totalLength","Children","map","virtualizedChildren","child","isValidElement","type","key","ref","element","Object","prototype","hasOwnProperty","call","localRef","createIndexedRef","components","container","slot","always","defaultProps","elementType"],"mappings":"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"}