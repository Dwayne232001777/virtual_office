{"version":3,"sources":["../../../../../packages/react-virtualizer/src/hooks/useMeasureList.ts"],"sourcesContent":["import * as React from 'react';\nimport { useFluent_unstable as useFluent } from '@fluentui/react-shared-contexts';\n\nexport interface IndexedResizeCallbackElement {\n  handleResize: () => void;\n}\n/**\n * Provides a way of automating size in the virtualizer\n * Returns\n * `width` - element width ref (0 by default),\n * `height` - element height ref (0 by default),\n * `measureElementRef` - a ref function to be passed as `ref` to the element you want to measure\n */\n\nconst SCROLL_ALLOWANCE = 100;\n\nexport function useMeasureList<\n  TElement extends HTMLElement & IndexedResizeCallbackElement = HTMLElement &\n    IndexedResizeCallbackElement\n>(measureParams: {\n  currentIndex: number;\n  totalLength: number;\n  virtualizerLength: number;\n  defaultItemSize: number;\n  sizeTrackingArray: React.MutableRefObject<number[]>;\n  axis: 'horizontal' | 'vertical';\n  requestScrollBy?: (sizeChange: number) => void;\n}): {\n  createIndexedRef: (index: number) => (el: TElement) => void;\n  refObject: React.MutableRefObject<{\n    [key: string]: TElement | null;\n  }>;\n} {\n  const {\n    currentIndex,\n    totalLength,\n    defaultItemSize,\n    sizeTrackingArray,\n    axis,\n    requestScrollBy,\n    virtualizerLength,\n  } = measureParams;\n\n  const { targetDocument } = useFluent();\n\n  // Use ref object to track and delete observed elements\n  const refObject = React.useRef<{ [key: string]: TElement | null }>({});\n\n  // the handler for resize observer\n  const handleIndexUpdate = React.useCallback(\n    (index: number) => {\n      const boundClientRect =\n        refObject.current[index.toString()]?.getBoundingClientRect();\n\n      if (!boundClientRect) {\n        return;\n      }\n\n      const containerSize =\n        (axis === 'vertical'\n          ? boundClientRect?.height\n          : boundClientRect?.width) ?? defaultItemSize;\n\n      const sizeDifference = containerSize - sizeTrackingArray.current[index];\n      // Todo: Handle reverse setup\n      // This requests a scrollBy to offset the new change\n      if (sizeDifference !== 0) {\n        const itemPosition = boundClientRect.bottom - SCROLL_ALLOWANCE;\n        if (axis === 'vertical' && itemPosition <= sizeDifference) {\n          requestScrollBy?.(sizeDifference);\n        } else if (axis === 'horizontal' && itemPosition <= sizeDifference) {\n          requestScrollBy?.(sizeDifference);\n        }\n      }\n\n      // Update size tracking array which gets exposed if teams need it\n      sizeTrackingArray.current[index] = containerSize;\n    },\n    [defaultItemSize, requestScrollBy, axis, sizeTrackingArray]\n  );\n\n  const handleElementResizeCallback = (entries: ResizeObserverEntry[]) => {\n    for (const entry of entries) {\n      const target = entry.target as TElement;\n      // Call the elements own resize handler (indexed)\n      target.handleResize();\n    }\n  };\n\n  React.useEffect(() => {\n    const newLength = totalLength - sizeTrackingArray.current.length;\n    /* Ensure we grow or truncate arrays with prior properties,\n    keeping the existing values is important for whitespace assumptions.\n    Even if items in the 'middle' are deleted, we will recalc the whitespace as it is explored.*/\n    if (newLength > 0) {\n      sizeTrackingArray.current = sizeTrackingArray.current.concat(\n        new Array(newLength).fill(defaultItemSize)\n      );\n    } else if (newLength < 0) {\n      sizeTrackingArray.current = sizeTrackingArray.current.slice(\n        0,\n        totalLength\n      );\n    }\n  }, [defaultItemSize, totalLength]);\n\n  // Keep the reference of ResizeObserver as a ref, as it should live through renders\n  const resizeObserver = React.useRef(\n    createResizeObserverFromDocument(\n      targetDocument,\n      handleElementResizeCallback\n    )\n  );\n\n  /* createIndexedRef provides a dynamic function to create an undefined number of refs at render time\n   * these refs then provide an indexed callback via attaching 'handleResize' to the element itself\n   * this function is then called on resize by handleElementResize and relies on indexing\n   * to track continuous sizes throughout renders while releasing all virtualized element refs each render cycle.\n   */\n  const createIndexedRef = React.useCallback(\n    (index: number) => {\n      const measureElementRef = (el: TElement) => {\n        if (!targetDocument || !resizeObserver.current) {\n          return;\n        }\n\n        if (el) {\n          el.handleResize = () => {\n            handleIndexUpdate(currentIndex + index);\n          };\n        }\n\n        const stringIndex = (index + currentIndex).toString();\n\n        // cleanup previous container\n        const prevEl = refObject.current[stringIndex];\n        delete refObject.current[stringIndex];\n        if (prevEl) {\n          // Only remove if it doesn't exist in array now (might have moved index)\n          resizeObserver.current.unobserve(prevEl);\n        }\n\n        if (el) {\n          refObject.current[stringIndex] = el;\n          resizeObserver.current.observe(el);\n          handleIndexUpdate(currentIndex + index);\n        }\n      };\n\n      return measureElementRef;\n    },\n    [handleIndexUpdate, resizeObserver, targetDocument, currentIndex]\n  );\n\n  React.useEffect(() => {\n    // Delete and unobserve any removed elements on index change\n    Object.keys(refObject.current).forEach((key: string) => {\n      const intKey = parseInt(key, 10);\n      if (intKey < currentIndex || intKey >= currentIndex + virtualizerLength) {\n        const el = refObject.current[key];\n        delete refObject.current[key];\n        if (el) {\n          resizeObserver.current?.unobserve(el);\n        }\n      }\n    });\n  }, [virtualizerLength, currentIndex]);\n\n  React.useEffect(() => {\n    const _resizeObserver = resizeObserver;\n    return () => _resizeObserver.current?.disconnect();\n  }, [resizeObserver]);\n\n  return {\n    createIndexedRef,\n    refObject,\n  };\n}\n\n/**\n * FIXME - TS 3.8/3.9 don't have ResizeObserver types by default, move this to a shared utility once we bump the minbar\n * A utility method that creates a ResizeObserver from a target document\n * @param targetDocument - document to use to create the ResizeObserver\n * @param callback  - https://developer.mozilla.org/en-US/docs/Web/API/ResizeObserver/ResizeObserver#callback\n * @returns a ResizeObserver instance or null if the global does not exist on the document\n */\nexport function createResizeObserverFromDocument(\n  targetDocument: Document | null | undefined,\n  callback: ResizeObserverCallback\n  // eslint-disable-next-line no-restricted-globals\n): ResizeObserver | null {\n  if (!targetDocument?.defaultView?.ResizeObserver) {\n    return null;\n  }\n\n  return new targetDocument.defaultView.ResizeObserver(callback);\n}\n"],"names":["createResizeObserverFromDocument","useMeasureList","SCROLL_ALLOWANCE","measureParams","currentIndex","totalLength","defaultItemSize","sizeTrackingArray","axis","requestScrollBy","virtualizerLength","targetDocument","useFluent","refObject","React","useRef","handleIndexUpdate","useCallback","index","boundClientRect","current","toString","getBoundingClientRect","containerSize","height","width","sizeDifference","itemPosition","bottom","handleElementResizeCallback","entries","entry","target","handleResize","useEffect","newLength","length","concat","Array","fill","slice","resizeObserver","createIndexedRef","measureElementRef","el","stringIndex","prevEl","unobserve","observe","Object","keys","forEach","key","intKey","parseInt","_resizeObserver","disconnect","callback","defaultView","ResizeObserver"],"mappings":";;;;;;;;;;;QA0LgBA;eAAAA;;QA1KAC;eAAAA;;;;iEAhBO;qCACyB;AAKhD;;;;;;CAMC,GAED,MAAMC,mBAAmB;AAElB,SAASD,eAGdE,aAQD;IAMC,MAAM,EACJC,YAAY,EACZC,WAAW,EACXC,eAAe,EACfC,iBAAiB,EACjBC,IAAI,EACJC,eAAe,EACfC,iBAAiB,EAClB,GAAGP;IAEJ,MAAM,EAAEQ,cAAc,EAAE,GAAGC,IAAAA,uCAAS;IAEpC,uDAAuD;IACvD,MAAMC,YAAYC,OAAMC,MAAM,CAAqC,CAAC;IAEpE,kCAAkC;IAClC,MAAMC,oBAAoBF,OAAMG,WAAW,CACzC,CAACC;YAEGL;QADF,MAAMM,mBACJN,oCAAAA,UAAUO,OAAO,CAACF,MAAMG,QAAQ,GAAG,qBAAnCR,kCAAqCS,qBAAqB;QAE5D,IAAI,CAACH,iBAAiB;YACpB;QACF;YAGGX;QADH,MAAMe,gBACJ,CAACf,OAAAA,SAAS,aACNW,mCAAAA,gBAAiBK,MAAM,GACvBL,mCAAAA,gBAAiBM,KAAK,YAFzBjB,OAE8BF;QAEjC,MAAMoB,iBAAiBH,gBAAgBhB,kBAAkBa,OAAO,CAACF,MAAM;QACvE,6BAA6B;QAC7B,oDAAoD;QACpD,IAAIQ,mBAAmB,GAAG;YACxB,MAAMC,eAAeR,gBAAgBS,MAAM,GAAG1B;YAC9C,IAAIM,SAAS,cAAcmB,gBAAgBD,gBAAgB;gBACzDjB,mCAAAA,gBAAkBiB;YACpB,OAAO,IAAIlB,SAAS,gBAAgBmB,gBAAgBD,gBAAgB;gBAClEjB,mCAAAA,gBAAkBiB;YACpB;QACF;QAEA,iEAAiE;QACjEnB,kBAAkBa,OAAO,CAACF,MAAM,GAAGK;IACrC,GACA;QAACjB;QAAiBG;QAAiBD;QAAMD;KAAkB;IAG7D,MAAMsB,8BAA8B,CAACC;QACnC,KAAK,MAAMC,SAASD,QAAS;YAC3B,MAAME,SAASD,MAAMC,MAAM;YAC3B,iDAAiD;YACjDA,OAAOC,YAAY;QACrB;IACF;IAEAnB,OAAMoB,SAAS,CAAC;QACd,MAAMC,YAAY9B,cAAcE,kBAAkBa,OAAO,CAACgB,MAAM;QAChE;;+FAE2F,GAC3F,IAAID,YAAY,GAAG;YACjB5B,kBAAkBa,OAAO,GAAGb,kBAAkBa,OAAO,CAACiB,MAAM,CAC1D,IAAIC,MAAMH,WAAWI,IAAI,CAACjC;QAE9B,OAAO,IAAI6B,YAAY,GAAG;YACxB5B,kBAAkBa,OAAO,GAAGb,kBAAkBa,OAAO,CAACoB,KAAK,CACzD,GACAnC;QAEJ;IACF,GAAG;QAACC;QAAiBD;KAAY;IAEjC,mFAAmF;IACnF,MAAMoC,iBAAiB3B,OAAMC,MAAM,CACjCf,iCACEW,gBACAkB;IAIJ;;;;GAIC,GACD,MAAMa,mBAAmB5B,OAAMG,WAAW,CACxC,CAACC;QACC,MAAMyB,oBAAoB,CAACC;YACzB,IAAI,CAACjC,kBAAkB,CAAC8B,eAAerB,OAAO,EAAE;gBAC9C;YACF;YAEA,IAAIwB,IAAI;gBACNA,GAAGX,YAAY,GAAG;oBAChBjB,kBAAkBZ,eAAec;gBACnC;YACF;YAEA,MAAM2B,cAAc,AAAC3B,CAAAA,QAAQd,YAAW,EAAGiB,QAAQ;YAEnD,6BAA6B;YAC7B,MAAMyB,SAASjC,UAAUO,OAAO,CAACyB,YAAY;YAC7C,OAAOhC,UAAUO,OAAO,CAACyB,YAAY;YACrC,IAAIC,QAAQ;gBACV,wEAAwE;gBACxEL,eAAerB,OAAO,CAAC2B,SAAS,CAACD;YACnC;YAEA,IAAIF,IAAI;gBACN/B,UAAUO,OAAO,CAACyB,YAAY,GAAGD;gBACjCH,eAAerB,OAAO,CAAC4B,OAAO,CAACJ;gBAC/B5B,kBAAkBZ,eAAec;YACnC;QACF;QAEA,OAAOyB;IACT,GACA;QAAC3B;QAAmByB;QAAgB9B;QAAgBP;KAAa;IAGnEU,OAAMoB,SAAS,CAAC;QACd,4DAA4D;QAC5De,OAAOC,IAAI,CAACrC,UAAUO,OAAO,EAAE+B,OAAO,CAAC,CAACC;YACtC,MAAMC,SAASC,SAASF,KAAK;YAC7B,IAAIC,SAASjD,gBAAgBiD,UAAUjD,eAAeM,mBAAmB;gBACvE,MAAMkC,KAAK/B,UAAUO,OAAO,CAACgC,IAAI;gBACjC,OAAOvC,UAAUO,OAAO,CAACgC,IAAI;gBAC7B,IAAIR,IAAI;wBACNH;qBAAAA,0BAAAA,eAAerB,OAAO,qBAAtBqB,wBAAwBM,SAAS,CAACH;gBACpC;YACF;QACF;IACF,GAAG;QAAClC;QAAmBN;KAAa;IAEpCU,OAAMoB,SAAS,CAAC;QACd,MAAMqB,kBAAkBd;QACxB,OAAO;gBAAMc;oBAAAA,0BAAAA,gBAAgBnC,OAAO,qBAAvBmC,wBAAyBC,UAAU;;IAClD,GAAG;QAACf;KAAe;IAEnB,OAAO;QACLC;QACA7B;IACF;AACF;AASO,SAASb,iCACdW,cAA2C,EAC3C8C,QAAgC;QAG3B9C;IAAL,IAAI,EAACA,mCAAAA,8BAAAA,eAAgB+C,WAAW,qBAA3B/C,4BAA6BgD,cAAc,GAAE;QAChD,OAAO;IACT;IAEA,OAAO,IAAIhD,eAAe+C,WAAW,CAACC,cAAc,CAACF;AACvD"}