{"version":3,"sources":["../../../../../packages/react-virtualizer/src/hooks/useDynamicPagination.ts"],"sourcesContent":["import * as React from 'react';\nimport { VirtualizerDynamicPaginationProps } from './hooks.types';\nimport { useTimeout } from '@fluentui/react-utilities';\n\n/**\n * Optional hook that will enable pagination on the virtualizer so that it 'autoscrolls' to an items exact position\n * Sizes are dynamic so we require a progressive sizing array (passed in from Dynamic virtualizer hooks)\n * On short scrolls, we will go at minimum to the next/previous item so that arrow pagination works\n * All VirtualizerDynamicPaginationProps can be grabbed from dynamic Virtualizer hooks externally and passed in\n */\nexport const useDynamicVirtualizerPagination = (\n  virtualizerProps: VirtualizerDynamicPaginationProps,\n  paginationEnabled = true\n): React.RefCallback<HTMLElement | HTMLDivElement | null> => {\n  'use no memo';\n\n  const {\n    axis = 'vertical',\n    currentIndex,\n    actualNodeSizes,\n    progressiveItemSizes,\n    virtualizerLength,\n  } = virtualizerProps;\n\n  const [setScrollTimer, clearScrollTimer] = useTimeout();\n  const lastScrollPos = React.useRef<number>(-1);\n  const lastIndexScrolled = React.useRef<number>(0);\n\n  const scrollContainer = React.useRef<HTMLElement | null>(null);\n\n  const clearListeners = () => {\n    if (scrollContainer.current) {\n      scrollContainer.current.removeEventListener('scroll', onScroll);\n      scrollContainer.current = null;\n      clearScrollTimer();\n    }\n  };\n\n  React.useEffect(() => {\n    return () => {\n      clearListeners();\n    };\n  }, []);\n\n  /**\n   * Handle scroll stop event and paginate to the closest item\n   * If the closest item is the same as the previous scroll end\n   * we paginate to the next/previous one based on direction\n   *\n   * Users/Virtualizer-Hooks must pass in a cumulative array of sizes\n   * This prevents the need to recalculate and ensures size arrays are synced externally\n   */\n  const onScrollEnd = React.useCallback(() => {\n    if (\n      !scrollContainer.current ||\n      !paginationEnabled ||\n      !progressiveItemSizes?.current ||\n      !actualNodeSizes.current\n    ) {\n      // No container found\n      return;\n    }\n\n    const currentScrollPos = Math.round(\n      axis === 'vertical'\n        ? scrollContainer.current.scrollTop\n        : scrollContainer.current.scrollLeft\n    );\n\n    const actualItemSizes = [0, ...progressiveItemSizes.current];\n    let closestItemPos = 0;\n    let closestItem = 0;\n    for (let i = 0; i < actualItemSizes.length - 1; i++) {\n      // First, update our progressive size array to the actual post-render measurement\n      if (i + 1 < actualItemSizes.length) {\n        actualItemSizes[i + 1] =\n          actualItemSizes[i] + actualNodeSizes.current[i];\n      }\n      if (\n        currentScrollPos <= actualItemSizes[i + 1] &&\n        currentScrollPos >= actualItemSizes[i]\n      ) {\n        // Found our in between position\n        const distanceToPrev = Math.abs(currentScrollPos - actualItemSizes[i]);\n        const distanceToNext = Math.abs(\n          actualItemSizes[i + 1] - currentScrollPos\n        );\n        if (distanceToPrev < distanceToNext) {\n          closestItem = i;\n        } else {\n          closestItem = i + 1;\n        }\n        break;\n      }\n    }\n\n    let nextItem = closestItem;\n    if (nextItem === lastIndexScrolled.current) {\n      // Special case for go to next/previous with minimum amount of scroll needed\n      const nextTarget = lastScrollPos.current < currentScrollPos ? 1 : -1;\n      // This will also handle a case where we scrolled to the exact correct position (noop)\n      const isSecondaryScroll =\n        Math.round(lastScrollPos.current - currentScrollPos) === 0;\n      const posMod = isSecondaryScroll ? 0 : nextTarget;\n      nextItem = closestItem + posMod;\n    }\n\n    // Safeguard nextItem\n    nextItem = Math.min(Math.max(0, nextItem), actualItemSizes.length);\n    closestItemPos = actualItemSizes[nextItem];\n\n    if (axis === 'vertical') {\n      scrollContainer.current.scrollTo({\n        top: closestItemPos,\n        behavior: 'smooth',\n      });\n    } else {\n      scrollContainer.current.scrollTo({\n        left: closestItemPos,\n        behavior: 'smooth',\n      });\n    }\n    lastScrollPos.current = closestItemPos;\n    lastIndexScrolled.current = nextItem;\n  }, [\n    paginationEnabled,\n    currentIndex,\n    scrollContainer,\n    virtualizerLength,\n    axis,\n    progressiveItemSizes,\n  ]);\n\n  /**\n   * On scroll timer that will continuously delay callback until scrolling stops\n   */\n  const onScroll = React.useCallback(() => {\n    clearScrollTimer();\n    setScrollTimer(onScrollEnd, 100);\n  }, [onScrollEnd, clearScrollTimer, setScrollTimer]);\n\n  /**\n   * Pagination ref will ensure we attach listeners to containers on change\n   * It is returned from hook and merged into the scroll container externally\n   */\n  const paginationRef = React.useCallback(\n    (instance: HTMLElement | HTMLDivElement | null) => {\n      if (!paginationEnabled) {\n        clearListeners();\n        scrollContainer.current = null;\n        return;\n      }\n      if (scrollContainer.current !== instance) {\n        clearListeners();\n\n        scrollContainer.current = instance;\n        if (scrollContainer.current) {\n          scrollContainer.current.addEventListener('scroll', onScroll);\n        }\n      }\n    },\n    [onScroll, onScrollEnd, paginationEnabled]\n  );\n\n  return paginationRef;\n};\n"],"names":["useDynamicVirtualizerPagination","virtualizerProps","paginationEnabled","axis","currentIndex","actualNodeSizes","progressiveItemSizes","virtualizerLength","setScrollTimer","clearScrollTimer","useTimeout","lastScrollPos","React","useRef","lastIndexScrolled","scrollContainer","clearListeners","current","removeEventListener","onScroll","useEffect","onScrollEnd","useCallback","currentScrollPos","Math","round","scrollTop","scrollLeft","actualItemSizes","closestItemPos","closestItem","i","length","distanceToPrev","abs","distanceToNext","nextItem","nextTarget","isSecondaryScroll","posMod","min","max","scrollTo","top","behavior","left","paginationRef","instance","addEventListener"],"mappings":";;;;+BAUaA;;;eAAAA;;;;iEAVU;gCAEI;AAQpB,MAAMA,kCAAkC,CAC7CC,kBACAC,oBAAoB,IAAI;IAExB;IAEA,MAAM,EACJC,OAAO,UAAU,EACjBC,YAAY,EACZC,eAAe,EACfC,oBAAoB,EACpBC,iBAAiB,EAClB,GAAGN;IAEJ,MAAM,CAACO,gBAAgBC,iBAAiB,GAAGC,IAAAA,0BAAU;IACrD,MAAMC,gBAAgBC,OAAMC,MAAM,CAAS,CAAC;IAC5C,MAAMC,oBAAoBF,OAAMC,MAAM,CAAS;IAE/C,MAAME,kBAAkBH,OAAMC,MAAM,CAAqB;IAEzD,MAAMG,iBAAiB;QACrB,IAAID,gBAAgBE,OAAO,EAAE;YAC3BF,gBAAgBE,OAAO,CAACC,mBAAmB,CAAC,UAAUC;YACtDJ,gBAAgBE,OAAO,GAAG;YAC1BR;QACF;IACF;IAEAG,OAAMQ,SAAS,CAAC;QACd,OAAO;YACLJ;QACF;IACF,GAAG,EAAE;IAEL;;;;;;;GAOC,GACD,MAAMK,cAAcT,OAAMU,WAAW,CAAC;QACpC,IACE,CAACP,gBAAgBE,OAAO,IACxB,CAACf,qBACD,EAACI,wCAAAA,qBAAsBW,OAAO,KAC9B,CAACZ,gBAAgBY,OAAO,EACxB;YACA,qBAAqB;YACrB;QACF;QAEA,MAAMM,mBAAmBC,KAAKC,KAAK,CACjCtB,SAAS,aACLY,gBAAgBE,OAAO,CAACS,SAAS,GACjCX,gBAAgBE,OAAO,CAACU,UAAU;QAGxC,MAAMC,kBAAkB;YAAC;eAAMtB,qBAAqBW,OAAO;SAAC;QAC5D,IAAIY,iBAAiB;QACrB,IAAIC,cAAc;QAClB,IAAK,IAAIC,IAAI,GAAGA,IAAIH,gBAAgBI,MAAM,GAAG,GAAGD,IAAK;YACnD,iFAAiF;YACjF,IAAIA,IAAI,IAAIH,gBAAgBI,MAAM,EAAE;gBAClCJ,eAAe,CAACG,IAAI,EAAE,GACpBH,eAAe,CAACG,EAAE,GAAG1B,gBAAgBY,OAAO,CAACc,EAAE;YACnD;YACA,IACER,oBAAoBK,eAAe,CAACG,IAAI,EAAE,IAC1CR,oBAAoBK,eAAe,CAACG,EAAE,EACtC;gBACA,gCAAgC;gBAChC,MAAME,iBAAiBT,KAAKU,GAAG,CAACX,mBAAmBK,eAAe,CAACG,EAAE;gBACrE,MAAMI,iBAAiBX,KAAKU,GAAG,CAC7BN,eAAe,CAACG,IAAI,EAAE,GAAGR;gBAE3B,IAAIU,iBAAiBE,gBAAgB;oBACnCL,cAAcC;gBAChB,OAAO;oBACLD,cAAcC,IAAI;gBACpB;gBACA;YACF;QACF;QAEA,IAAIK,WAAWN;QACf,IAAIM,aAAatB,kBAAkBG,OAAO,EAAE;YAC1C,4EAA4E;YAC5E,MAAMoB,aAAa1B,cAAcM,OAAO,GAAGM,mBAAmB,IAAI,CAAC;YACnE,sFAAsF;YACtF,MAAMe,oBACJd,KAAKC,KAAK,CAACd,cAAcM,OAAO,GAAGM,sBAAsB;YAC3D,MAAMgB,SAASD,oBAAoB,IAAID;YACvCD,WAAWN,cAAcS;QAC3B;QAEA,qBAAqB;QACrBH,WAAWZ,KAAKgB,GAAG,CAAChB,KAAKiB,GAAG,CAAC,GAAGL,WAAWR,gBAAgBI,MAAM;QACjEH,iBAAiBD,eAAe,CAACQ,SAAS;QAE1C,IAAIjC,SAAS,YAAY;YACvBY,gBAAgBE,OAAO,CAACyB,QAAQ,CAAC;gBAC/BC,KAAKd;gBACLe,UAAU;YACZ;QACF,OAAO;YACL7B,gBAAgBE,OAAO,CAACyB,QAAQ,CAAC;gBAC/BG,MAAMhB;gBACNe,UAAU;YACZ;QACF;QACAjC,cAAcM,OAAO,GAAGY;QACxBf,kBAAkBG,OAAO,GAAGmB;IAC9B,GAAG;QACDlC;QACAE;QACAW;QACAR;QACAJ;QACAG;KACD;IAED;;GAEC,GACD,MAAMa,WAAWP,OAAMU,WAAW,CAAC;QACjCb;QACAD,eAAea,aAAa;IAC9B,GAAG;QAACA;QAAaZ;QAAkBD;KAAe;IAElD;;;GAGC,GACD,MAAMsC,gBAAgBlC,OAAMU,WAAW,CACrC,CAACyB;QACC,IAAI,CAAC7C,mBAAmB;YACtBc;YACAD,gBAAgBE,OAAO,GAAG;YAC1B;QACF;QACA,IAAIF,gBAAgBE,OAAO,KAAK8B,UAAU;YACxC/B;YAEAD,gBAAgBE,OAAO,GAAG8B;YAC1B,IAAIhC,gBAAgBE,OAAO,EAAE;gBAC3BF,gBAAgBE,OAAO,CAAC+B,gBAAgB,CAAC,UAAU7B;YACrD;QACF;IACF,GACA;QAACA;QAAUE;QAAanB;KAAkB;IAG5C,OAAO4C;AACT"}