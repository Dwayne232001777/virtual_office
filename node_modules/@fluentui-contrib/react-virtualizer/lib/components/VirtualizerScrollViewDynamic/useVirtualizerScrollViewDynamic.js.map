{"version":3,"sources":["../../../../../../packages/react-virtualizer/src/components/VirtualizerScrollViewDynamic/useVirtualizerScrollViewDynamic.tsx"],"sourcesContent":["import * as React from 'react';\nimport { slot, useMergedRefs } from '@fluentui/react-utilities';\nimport { useVirtualizer_unstable } from '../Virtualizer/useVirtualizer';\nimport type {\n  VirtualizerScrollViewDynamicProps,\n  VirtualizerScrollViewDynamicState,\n} from './VirtualizerScrollViewDynamic.types';\nimport { useDynamicVirtualizerMeasure } from '../../Hooks';\nimport {\n  useVirtualizerContextState_unstable,\n  scrollToItemDynamic,\n} from '../../Utilities';\nimport type { VirtualizerDataRef } from '../Virtualizer/Virtualizer.types';\nimport { useMeasureList } from '../../hooks/useMeasureList';\nimport type { IndexedResizeCallbackElement } from '../../hooks/useMeasureList';\nimport { useDynamicVirtualizerPagination } from '../../hooks/useDynamicPagination';\n\nexport function useVirtualizerScrollViewDynamic_unstable(\n  props: VirtualizerScrollViewDynamicProps\n): VirtualizerScrollViewDynamicState {\n  'use no memo';\n\n  const contextState = useVirtualizerContextState_unstable(\n    props.virtualizerContext\n  );\n  const {\n    imperativeRef,\n    axis = 'vertical',\n    reversed,\n    imperativeVirtualizerRef,\n    enablePagination = false,\n    bufferItems: _bufferItems,\n    bufferSize: _bufferSize,\n    enableScrollAnchor,\n    gap = 0,\n  } = props;\n\n  const sizeTrackingArray = React.useRef<number[]>(\n    new Array(props.numItems).fill(props.itemSize)\n  );\n\n  const getChildSizeAuto = (index: number) => {\n    if (\n      sizeTrackingArray.current.length <= index ||\n      sizeTrackingArray.current[index] <= 0\n    ) {\n      // Default size for initial state or untracked\n      return props.itemSize;\n    }\n    /* Required to be defined prior to our measure function\n     * we use a sizing array ref that we will update post-render\n     */\n    return sizeTrackingArray.current[index];\n  };\n\n  const {\n    virtualizerLength,\n    bufferItems,\n    bufferSize,\n    scrollRef,\n    containerSizeRef,\n    updateScrollPosition,\n  } = useDynamicVirtualizerMeasure({\n    defaultItemSize: props.itemSize,\n    direction: props.axis ?? 'vertical',\n    getItemSize: props.getItemSize ?? getChildSizeAuto,\n    virtualizerContext: contextState,\n    numItems: props.numItems,\n    bufferItems: _bufferItems,\n    bufferSize: _bufferSize,\n    gap,\n  });\n\n  const _imperativeVirtualizerRef = useMergedRefs(\n    React.useRef<VirtualizerDataRef>(null),\n    imperativeVirtualizerRef\n  );\n\n  const paginationRef = useDynamicVirtualizerPagination(\n    {\n      axis,\n      progressiveItemSizes: _imperativeVirtualizerRef.current?.progressiveSizes,\n      actualNodeSizes: sizeTrackingArray,\n      virtualizerLength,\n      currentIndex: contextState?.contextIndex ?? 0,\n    },\n    enablePagination\n  );\n\n  // Store the virtualizer length as a ref for imperative ref access\n  const virtualizerLengthRef = React.useRef<number>(virtualizerLength);\n  if (virtualizerLengthRef.current !== virtualizerLength) {\n    virtualizerLengthRef.current = virtualizerLength;\n  }\n  const localScrollRef = React.useRef<HTMLDivElement>(null);\n  const scrollViewRef = useMergedRefs(\n    props.scrollViewRef,\n    scrollRef,\n    paginationRef,\n    localScrollRef\n  );\n  const scrollCallbackRef = React.useRef<null | ((index: number) => void)>(\n    null\n  );\n\n  React.useImperativeHandle(\n    imperativeRef,\n    () => {\n      return {\n        scrollToPosition(\n          position: number,\n          behavior: ScrollBehavior = 'auto',\n          index?: number, // So we can callback when index rendered\n          callback?: (index: number) => void\n        ) {\n          if (callback) {\n            scrollCallbackRef.current = callback ?? null;\n          }\n\n          if (_imperativeVirtualizerRef.current) {\n            if (index !== undefined) {\n              _imperativeVirtualizerRef.current.setFlaggedIndex(index);\n            }\n            const positionOptions =\n              axis == 'vertical' ? { top: position } : { left: position };\n            scrollViewRef.current?.scrollTo({\n              behavior,\n              ...positionOptions,\n            });\n          }\n        },\n        scrollTo(\n          index: number,\n          behavior = 'auto',\n          callback: undefined | ((index: number) => void)\n        ) {\n          scrollCallbackRef.current = callback ?? null;\n          if (_imperativeVirtualizerRef.current) {\n            const progressiveSizes =\n              _imperativeVirtualizerRef.current.progressiveSizes.current;\n            const totalSize =\n              progressiveSizes && progressiveSizes?.length > 0\n                ? progressiveSizes[Math.max(progressiveSizes.length - 1, 0)]\n                : 0;\n\n            _imperativeVirtualizerRef.current.setFlaggedIndex(index);\n            scrollToItemDynamic({\n              index,\n              getItemSize: props.getItemSize ?? getChildSizeAuto,\n              totalSize,\n              scrollViewRef: scrollViewRef as React.RefObject<HTMLDivElement>,\n              axis,\n              reversed,\n              behavior,\n              gap,\n            });\n          }\n        },\n        currentIndex: _imperativeVirtualizerRef.current?.currentIndex,\n        virtualizerLength: virtualizerLengthRef,\n        sizeTrackingArray,\n      };\n    },\n    [axis, scrollViewRef, reversed, _imperativeVirtualizerRef]\n  );\n\n  const handleRenderedIndex = (index: number) => {\n    if (scrollCallbackRef.current) {\n      scrollCallbackRef.current(index);\n    }\n  };\n\n  const virtualizerState = useVirtualizer_unstable({\n    ...props,\n    getItemSize: props.getItemSize ?? getChildSizeAuto,\n    virtualizerLength,\n    bufferItems,\n    bufferSize,\n    virtualizerContext: contextState,\n    imperativeVirtualizerRef: _imperativeVirtualizerRef,\n    onRenderedFlaggedIndex: handleRenderedIndex,\n    containerSizeRef,\n    scrollViewRef,\n    updateScrollPosition,\n  });\n\n  const requestScrollBy = React.useCallback(\n    (sizeChange: number) => {\n      // Handle any size changes so that scroll view doesn't jump around\n      if (enableScrollAnchor) {\n        localScrollRef.current?.scrollBy({\n          top: axis === 'vertical' ? sizeChange : 0,\n          left: axis === 'vertical' ? 0 : sizeChange,\n          behavior: 'instant',\n        });\n      }\n    },\n    [enableScrollAnchor, axis, localScrollRef]\n  );\n\n  const measureObject = useMeasureList({\n    currentIndex: Math.max(virtualizerState.virtualizerStartIndex, 0),\n    totalLength: props.numItems,\n    defaultItemSize: props.itemSize,\n    sizeTrackingArray,\n    axis,\n    virtualizerLength,\n    requestScrollBy,\n  });\n\n  // Enables auto-measuring and tracking post render sizes externally\n  React.Children.map(virtualizerState.virtualizedChildren, (child, index) => {\n    if (React.isValidElement(child)) {\n      virtualizerState.virtualizedChildren[index] = (\n        <child.type\n          {...child.props}\n          key={child.key}\n          ref={(element: HTMLElement & IndexedResizeCallbackElement) => {\n            if (Object.prototype.hasOwnProperty.call(child, 'ref')) {\n              // We must access this from the child directly, not props (forward ref).\n              // eslint-disable-next-line  @typescript-eslint/no-explicit-any\n              const localRef = (child as any)?.ref;\n\n              if (typeof localRef === 'function') {\n                localRef(element);\n              } else if (localRef) {\n                localRef.current = element;\n              }\n            }\n\n            // Call the auto-measure ref attachment.\n            measureObject.createIndexedRef(index)(element);\n          }}\n        />\n      );\n    }\n  });\n\n  return {\n    ...virtualizerState,\n    enableScrollAnchor,\n    components: {\n      ...virtualizerState.components,\n      container: 'div',\n    },\n    container: slot.always(props.container, {\n      defaultProps: {\n        ref: scrollViewRef,\n      },\n      elementType: 'div',\n    }),\n  };\n}\n"],"names":["React","slot","useMergedRefs","useVirtualizer_unstable","useDynamicVirtualizerMeasure","useVirtualizerContextState_unstable","scrollToItemDynamic","useMeasureList","useDynamicVirtualizerPagination","useVirtualizerScrollViewDynamic_unstable","props","_imperativeVirtualizerRef","contextState","virtualizerContext","imperativeRef","axis","reversed","imperativeVirtualizerRef","enablePagination","bufferItems","_bufferItems","bufferSize","_bufferSize","enableScrollAnchor","gap","sizeTrackingArray","useRef","Array","numItems","fill","itemSize","getChildSizeAuto","index","current","length","virtualizerLength","scrollRef","containerSizeRef","updateScrollPosition","defaultItemSize","direction","getItemSize","paginationRef","progressiveItemSizes","progressiveSizes","actualNodeSizes","currentIndex","contextIndex","virtualizerLengthRef","localScrollRef","scrollViewRef","scrollCallbackRef","useImperativeHandle","scrollToPosition","position","behavior","callback","undefined","setFlaggedIndex","positionOptions","top","left","scrollTo","totalSize","Math","max","handleRenderedIndex","virtualizerState","onRenderedFlaggedIndex","requestScrollBy","useCallback","sizeChange","scrollBy","measureObject","virtualizerStartIndex","totalLength","Children","map","virtualizedChildren","child","isValidElement","type","key","ref","element","Object","prototype","hasOwnProperty","call","localRef","createIndexedRef","components","container","always","defaultProps","elementType"],"mappings":"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"}